// Prisma schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @db.Uuid
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())

  // Relations
  contacts           Contact[]
  conversations      Conversation[]
  linkedInEmailEvents LinkedInEmailEvent[]
  categories         Category[]
  stages             Stage[]
  opportunities      Opportunity[]
  settings           UserSettings?
  companies          Company[]
  jobPostings        JobPosting[]
  challenges         Challenge[]

  @@map("users")
}

model UserSettings {
  id                        String   @id @default(uuid()) @db.Uuid
  userId                    String   @unique @db.Uuid
  activeOpportunitiesGoal   Int      @default(15) @map("active_opportunities_goal")
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model Category {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  contacts     Contact[]
  opportunities Opportunity[]

  @@unique([userId, name])
  @@map("categories")
}

model Stage {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  name        String
  description String?
  order       Int      // For sorting stages in the funnel
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  contacts      Contact[]
  opportunities Opportunity[]

  @@unique([userId, name])
  @@map("stages")
}

model Contact {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @db.Uuid
  name            String
  headlineOrRole  String?  @map("headline_or_role")
  company         String?  // Legacy field, kept for backwards compatibility
  companyId       String?  @map("company_id") @db.Uuid // Link to Company model
  primaryPlatform String?  @map("primary_platform")
  profileLinks    Json?    @map("profile_links") // { linkedin: "url", twitter: "handle" }
  tags            String[] // Array of tags
  categoryId      String?  @db.Uuid
  stageId         String?  @db.Uuid
  
  // Strategy tracking fields
  email                    String?   // Email address for Loom Email Outreach
  warmOrCold               String?   @map("warm_or_cold") // "warm" | "cold" for SMART strategy
  commonGround             String?   @map("common_ground") @db.Text // Shared connections/background
  firstMessageDate         DateTime? @map("first_message_date") // When first outreach was sent
  referralGiven            Boolean   @default(false) @map("referral_given")
  referralGivenAt          DateTime? @map("referral_given_at")
  referralDetails          String?   @map("referral_details") @db.Text
  connectionRequestSentAt  DateTime? @map("connection_request_sent_at")
  connectionAcceptedAt     DateTime? @map("connection_accepted_at")
  connectionStatus         String?   @map("connection_status") // "not_connected" | "request_sent" | "connected"
  dmSentAt                 DateTime? @map("dm_sent_at")
  lastFollowUpAt           DateTime? @map("last_follow_up_at")
  contactType              String?   @map("contact_type") // "hiring_manager" | "recruiter" | "founder" | "other"
  strategyIds              String[]  @map("strategy_ids") // Array of strategy IDs this contact is linked to
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  category      Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  stage         Stage?        @relation(fields: [stageId], references: [id], onDelete: SetNull)
  companyRelation Company?    @relation(fields: [companyId], references: [id], onDelete: SetNull)
  conversations Conversation[]
  opportunities Opportunity[]
  challengeContacts ChallengeContact[]

  @@index([userId])
  @@index([companyId])
  @@index([warmOrCold])
  @@index([connectionStatus])
  @@map("contacts")
}

model Opportunity {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @db.Uuid
  contactId       String    @db.Uuid // Primary contact for this opportunity
  title           String?   // e.g., "Software Engineer at StartupXYZ" or "Networking with Jane"
  categoryId      String?   @db.Uuid
  stageId         String?   @db.Uuid
  nextActionType  String?   @map("next_action_type")
  nextActionDueAt DateTime? @map("next_action_due_at")
  priority        String?   // "low", "medium", "high", or null for closed
  summary         String?   // AI-generated summary of the overall opportunity
  notes           String?   // User's personal notes about the opportunity
  autoFollowupsEnabled Boolean @default(true) @map("auto_followups_enabled")
  
  // Strategy tracking fields
  strategyIds              String[]  @map("strategy_ids") // Array of strategy IDs
  proofOfWorkType          String?   @map("proof_of_work_type") // "proof_of_work_bugs" | "proof_of_work_build" | "other"
  issuesFound              Json?     @map("issues_found") // Array of issues with screenshots/notes
  projectDetails           String?   @map("project_details") @db.Text
  loomVideoUrl             String?   @map("loom_video_url")
  githubRepoUrl            String?   @map("github_repo_url")
  liveDemoUrl              String?   @map("live_demo_url")
  sharedChannels           String[]  @map("shared_channels") // ["slack", "linkedin", "discord", etc.]
  teamResponses            Json?     @map("team_responses") // Array of responses from team members
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact      Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)
  category     Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  stage        Stage?        @relation(fields: [stageId], references: [id], onDelete: SetNull)
  conversations Conversation[]
  jobPosting   JobPosting?

  @@index([userId])
  @@index([contactId])
  @@index([userId, stageId])
  @@index([nextActionDueAt])
  @@index([proofOfWorkType])
  @@map("opportunities")
}

model Conversation {
  id                  String    @id @default(uuid()) @db.Uuid
  userId              String    @db.Uuid
  contactId           String    @db.Uuid
  opportunityId       String?   @db.Uuid // Links conversation to opportunity (nullable for backwards compatibility)
  channel             String    // e.g., "linkedin", "email", "twitter"
  lastMessageAt       DateTime? @map("last_message_at")
  lastMessageSide     String?   @map("last_message_side") // "user" or "contact"
  lastMessageSnippet  String?   @map("last_message_snippet")
  categoryId          String?   @db.Uuid // Kept for backwards compatibility
  stageId             String?   @db.Uuid // Kept for backwards compatibility
  nextActionType      String?   @map("next_action_type")
  nextActionDueAt     DateTime? @map("next_action_due_at")
  priority            String?   @default("medium") // "low", "medium", "high", or null for closed conversations
  isOutOfSync         Boolean   @default(false) @map("is_out_of_sync")
  summary             String?   // AI-generated summary
  notes               String?   // User's personal notes
  originalUrl         String?   @map("original_url") // URL to the original conversation (e.g., LinkedIn)
  autoFollowupsEnabled Boolean  @default(true) @map("auto_followups_enabled")
  
  // Strategy tracking fields
  strategyIds              String[]  @map("strategy_ids") // Array of strategy IDs
  responseReceived         Boolean   @default(false) @map("response_received")
  responseReceivedAt       DateTime? @map("response_received_at")
  emailSentAt              DateTime? @map("email_sent_at") // When email was sent (separate from LinkedIn)
  loomVideoUrl             String?   @map("loom_video_url") // Link to Loom video sent
  loomSent                 Boolean   @default(false) @map("loom_sent")
  emailFollowUpDates       DateTime[] @map("email_follow_up_dates") // Array of follow-up dates
  emailStatus              String?   @map("email_status") // "no_reply" | "replied" | "call_scheduled" | "rejected" | "in_process"
  followUp1Date            DateTime? @map("follow_up_1_date")
  followUp2Date            DateTime? @map("follow_up_2_date")
  followUp3Date            DateTime? @map("follow_up_3_date")
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact           Contact            @relation(fields: [contactId], references: [id], onDelete: Cascade)
  opportunity       Opportunity?       @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  category          Category?          @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  stage             Stage?             @relation(fields: [stageId], references: [id], onDelete: SetNull)
  messages          Message[]
  linkedInEmailEvents LinkedInEmailEvent[]
  challengeConversations ChallengeConversation[]

  @@index([userId])
  @@index([contactId])
  @@index([opportunityId])
  @@index([userId, channel])
  @@index([userId, stageId])
  @@index([nextActionDueAt])
  @@index([emailStatus])
  @@map("conversations")
}

model Message {
  id            String   @id @default(uuid()) @db.Uuid
  conversationId String  @db.Uuid
  sender        String   // "user" or "contact"
  body          String   @db.Text
  sentAt        DateTime @map("sent_at")
  source        String   // "linkedin_export", "email_notification", "manual_reply", "other"
  status        String   @default("pending") // "pending" or "confirmed" - tracks if user-created messages were actually sent in the original platform
  rawMetadata   Json?    @map("raw_metadata")
  createdAt     DateTime @default(now())

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([sentAt])
  @@index([status])
  @@map("messages")
}

model LinkedInEmailEvent {
  id                   String    @id @default(uuid()) @db.Uuid
  userId               String    @db.Uuid
  senderName           String    @map("sender_name")
  senderProfileUrl     String?   @map("sender_profile_url")
  subject              String
  snippet              String?   @db.Text
  emailReceivedAt      DateTime  @map("email_received_at")
  matchedConversationId String?  @map("matched_conversation_id") @db.Uuid
  createdAt            DateTime  @default(now())

  // Relations
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  matchedConversation Conversation? @relation(fields: [matchedConversationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([emailReceivedAt])
  @@index([matchedConversationId])
  @@map("linkedin_email_events")
}

model Company {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @db.Uuid
  name              String
  industry          String?
  fundingRound      String?  @map("funding_round") // "Seed" | "Series A" | "Series B" | etc.
  fundingDate       DateTime? @map("funding_date")
  fundingSource     String?  @map("funding_source") // "Crunchbase" | "article" | "growth list" | "other"
  careersPageUrl    String?  @map("careers_page_url")
  hasRelevantRole   Boolean  @default(false) @map("has_relevant_role")
  roleTitle         String?  @map("role_title")
  applied           Boolean  @default(false)
  applicationDate   DateTime? @map("application_date")
  notes             String?  @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  contacts  Contact[]
  jobPostings JobPosting[]

  @@index([userId])
  @@index([fundingDate])
  @@index([fundingRound])
  @@map("companies")
}

model JobPosting {
  id                  String    @id @default(uuid()) @db.Uuid
  userId              String    @db.Uuid
  companyId           String?   @map("company_id") @db.Uuid
  jobTitle            String    @map("job_title")
  jobUrl              String    @map("job_url")
  postedAt            DateTime? @map("posted_at")
  applicantsWhenFound String?   @map("applicants_when_found") // "0", "<25", "100+", etc.
  source              String    // "linkedin_post" | "linkedin_job" | "other"
  opportunityId       String?   @unique @map("opportunity_id") @db.Uuid // Link to opportunity if converted
  outreachDone        Boolean   @default(false) @map("outreach_done")
  outreachChannels    String[]  @map("outreach_channels") // ["dm", "email", "loom", etc.]
  contactsFound       Json?     @map("contacts_found") // Array of contact IDs or names
  notes               String?   @db.Text
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  company     Company?    @relation(fields: [companyId], references: [id], onDelete: SetNull)
  opportunity Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([companyId])
  @@index([postedAt])
  @@index([source])
  @@map("job_postings")
}

model Challenge {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @db.Uuid
  name              String   // e.g., "100-Connection Week"
  startDate         DateTime @map("start_date")
  endDate           DateTime @map("end_date")
  goal              Int      // e.g., 100
  outreachesCount   Int      @default(0) @map("outreaches_count")
  acceptsCount      Int      @default(0) @map("accepts_count")
  repliesCount      Int      @default(0) @map("replies_count")
  callsCount        Int      @default(0) @map("calls_count")
  interviewsCount   Int      @default(0) @map("interviews_count")
  notes             String?  @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  challengeContacts   ChallengeContact[]
  challengeConversations ChallengeConversation[]

  @@index([userId])
  @@index([startDate])
  @@index([endDate])
  @@map("challenges")
}

model ChallengeContact {
  id          String   @id @default(uuid()) @db.Uuid
  challengeId String   @map("challenge_id") @db.Uuid
  contactId   String   @map("contact_id") @db.Uuid
  createdAt   DateTime @default(now())

  // Relations
  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  contact   Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([challengeId, contactId])
  @@index([challengeId])
  @@index([contactId])
  @@map("challenge_contacts")
}

model ChallengeConversation {
  id            String   @id @default(uuid()) @db.Uuid
  challengeId   String   @map("challenge_id") @db.Uuid
  conversationId String  @map("conversation_id") @db.Uuid
  createdAt     DateTime @default(now())

  // Relations
  challenge   Challenge   @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([challengeId, conversationId])
  @@index([challengeId])
  @@index([conversationId])
  @@map("challenge_conversations")
}

